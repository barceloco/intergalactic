---
- name: Install fail2ban
  apt:
    name: fail2ban
    state: present
    update_cache: true
  when: enable_fail2ban | default(true)

- name: Configure fail2ban jail.local for sshd (nftables)
  when: enable_fail2ban | default(true)
  copy:
    dest: /etc/fail2ban/jail.local
    mode: "0644"
    content: |
      [DEFAULT]
      banaction = nftables-multiport
      bantime  = {{ fail2ban_bantime_seconds }}
      findtime = 10m
      maxretry = {{ fail2ban_maxretry }}

      [sshd]
      enabled = true
      port = {{ ssh_port }}
      logpath = %(sshd_log)s

- name: Create persistent offender log directory
  file:
    path: /var/log/intergalactic
    state: directory
    mode: "0750"
    owner: root
    group: root
  when: enable_fail2ban | default(true)

- name: Add fail2ban action to log offender IPs
  when: enable_fail2ban | default(true)
  copy:
    dest: /etc/fail2ban/action.d/intergalactic-log.conf
    mode: "0644"
    content: |
      [Definition]
      actionban = /usr/bin/printf "%s %s %s\n" "$(date -Is)" "<name>" "<ip>" >> /var/log/intergalactic/fail2ban-offenders.log
      actionunban = true

- name: Enable extra action for sshd jail
  blockinfile:
    path: /etc/fail2ban/jail.local
    insertafter: '^\[sshd\]'
    block: |
      action = %(action_)s
               intergalactic-log[name=sshd]
  notify: Restart fail2ban
  when: enable_fail2ban | default(true)

- name: Ensure fail2ban enabled and running
  service:
    name: fail2ban
    enabled: "{{ enable_fail2ban | default(true) }}"
    state: "{{ 'started' if (enable_fail2ban | default(true)) else 'stopped' }}"
  when: enable_fail2ban | default(true)

- name: Ensure fail2ban is stopped and disabled when disabled
  service:
    name: fail2ban
    enabled: false
    state: stopped
  when: not (enable_fail2ban | default(true))

- name: Display fail2ban status
  debug:
    msg: |
      ============================================================================
      Fail2ban Status: {{ 'ENABLED' if (enable_fail2ban | default(true)) else 'DISABLED' }}
      ============================================================================
      {% if enable_fail2ban | default(true) %}
      Fail2ban is configured and running.
      - Max retries before ban: {{ fail2ban_maxretry }}
      - Ban duration: {{ (fail2ban_bantime_seconds / 86400) | int }} days (effectively permanent)
      - Offender log: /var/log/intergalactic/fail2ban-offenders.log
      {% else %}
      Fail2ban is disabled. Authentication failures will not trigger bans.
      {% endif %}
      ============================================================================
  when: enable_fail2ban is defined
