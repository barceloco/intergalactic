http:
  middlewares:
    security-headers:
      headers:
{% if not (edge_ingress_disable_tls | default(false)) %}
        sslRedirect: true
        forceSTSHeader: true
        stsIncludeSubdomains: true
        stsPreload: true
        stsSeconds: 31536000
{% endif %}
        customFrameOptionsValue: "SAMEORIGIN"
        customRequestHeaders:
          X-Forwarded-Proto: "https"
        customResponseHeaders:
          X-Content-Type-Options: "nosniff"
          X-Frame-Options: "SAMEORIGIN"
          X-XSS-Protection: "1; mode=block"
          Referrer-Policy: "strict-origin-when-cross-origin"
          Permissions-Policy: "geolocation=(), microphone=(), camera=()"

    retry:
      retry:
        attempts: 3
        initialInterval: 100ms

    # Middleware to set Content-Type for HTML responses (for services that don't send it)
    content-type-html:
      headers:
        customResponseHeaders:
          Content-Type: "text/html; charset=utf-8"

    # Middleware to remove CSP header (for services behind reverse proxy that have restrictive CSP)
    remove-csp:
      headers:
        customResponseHeaders:
          Content-Security-Policy: ""

  routers:
{% for route in final_routes | default(edge_ingress_routes) %}
    router-{{ route.host | regex_replace('\\.', '-') | regex_replace('^([^-]+)-.*', '\\1') }}:
      rule: "Host(`{{ route.host }}`)"
      entryPoints:
{% if edge_ingress_disable_tls | default(false) %}
        - web
{% else %}
        - websecure
{% endif %}
      service: service-{{ route.host | regex_replace('\\.', '-') | regex_replace('^([^-]+)-.*', '\\1') }}
      middlewares:
        - security-headers
        - retry
{% if route.force_html_content_type | default(false) %}
        - remove-csp
        - content-type-html
{% endif %}
{% if not (edge_ingress_disable_tls | default(false)) %}
      tls:
        certResolver: letsencrypt
{% endif %}

{% endfor %}

  services:
{% for route in final_routes | default(edge_ingress_routes) %}
    service-{{ route.host | regex_replace('\\.', '-') | regex_replace('^([^-]+)-.*', '\\1') }}:
      loadBalancer:
{% if route.health_path is defined and route.health_path | length > 0 %}
        healthCheck:
          path: "{{ route.health_path }}"
          interval: "{{ edge_ingress_health_check_interval }}"
          timeout: "{{ edge_ingress_health_check_timeout }}"
          scheme: http
{% endif %}
        servers:
          - url: "{{ route.backend_resolved | default(route.backend) }}"

{% endfor %}
