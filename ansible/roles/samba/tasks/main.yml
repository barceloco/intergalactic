---
- name: Install Samba
  apt:
    name: samba
    state: present
    update_cache: true
  when: enable_samba | default(false)

- name: Ensure armand user exists
  when: enable_samba | default(false)
  user:
    name: armand
    shell: /bin/bash
    create_home: true
    state: present

- name: Create Samba share directory for armand
  when: enable_samba | default(false)
  file:
    path: /home/armand/samba
    state: directory
    owner: armand
    group: armand
    mode: '0755'

- name: Deploy Samba configuration
  when: enable_samba | default(false)
  template:
    src: smb.conf.j2
    dest: /etc/samba/smb.conf
    mode: '0644'
    owner: root
    group: root
  notify: Restart smbd

- name: Check if armand user exists in Samba
  when: enable_samba | default(false)
  command: pdbedit -L
  register: samba_users
  changed_when: false
  failed_when: false

- name: Add armand user to Samba (no password - uses system password via PAM)
  when: 
    - enable_samba | default(false)
    - "armand" not in samba_users.stdout
  command: smbpasswd -a -n armand
  # -n flag creates user without password, Samba will use system password via PAM
  changed_when: true
  failed_when: false

- name: Enable armand user in Samba
  when: enable_samba | default(false)
  command: smbpasswd -e armand
  changed_when: true
  failed_when: false

- name: Ensure Samba services are enabled and running
  when: enable_samba | default(false)
  service:
    name: "{{ item }}"
    enabled: true
    state: started
  loop:
    - smbd
    - nmbd
