---
- name: Install Samba
  apt:
    name: samba
    state: present
    update_cache: true
  when: enable_samba | default(false)

- name: Ensure armand user exists
  when: enable_samba | default(false)
  user:
    name: armand
    shell: /bin/bash
    create_home: true
    state: present

- name: Create Samba share directory (crypt)
  when: enable_samba | default(false)
  file:
    path: /crypt
    state: directory
    owner: armand
    group: armand
    mode: '0755'

- name: Deploy Samba configuration
  when: enable_samba | default(false)
  template:
    src: smb.conf.j2
    dest: /etc/samba/smb.conf
    mode: '0644'
    owner: root
    group: root
  notify: Restart smbd

- name: Check if armand user exists in Samba
  when: enable_samba | default(false)
  command: pdbedit -L
  register: samba_users
  changed_when: false
  failed_when: false

- name: Remove armand from Samba database (let PAM handle authentication)
  when:
    - enable_samba | default(false)
    - samba_users.stdout is defined
    - (samba_users.stdout | default('')) is search('armand')
  command: pdbedit -x armand
  register: remove_samba_user
  changed_when: remove_samba_user.rc == 0
  failed_when: false
  no_log: true

- name: Ensure Samba services are enabled and running
  when: enable_samba | default(false)
  service:
    name: "{{ item }}"
    enabled: true
    state: started
  loop:
    - smbd
    - nmbd
