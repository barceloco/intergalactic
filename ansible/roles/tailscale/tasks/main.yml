---
- name: Install tailscale (Debian repo)
  when: enable_tailscale | default(false)
  block:
    - name: Validate Tailscale auth key is set
      assert:
        that:
          - tailscale_authkey is defined
          - tailscale_authkey | length > 0
          - tailscale_authkey != "tskey-REPLACE_ME"
          - not tailscale_authkey.startswith("tskey-REPLACE")
        fail_msg: |
          Tailscale auth key is not set or is a placeholder.
          Please set tailscale_authkey in all.secrets.yml
          See all.secrets.yml.example for template.
        success_msg: "Tailscale auth key is configured"
    - name: Install prerequisites
      apt:
        name:
          - curl
          - ca-certificates
          - gnupg
        state: present
        update_cache: true

    - name: Add Tailscale apt keyring
      shell: |
        install -d -m 0755 /usr/share/keyrings
        curl -fsSL https://pkgs.tailscale.com/stable/debian/{{ ansible_distribution_release }}.noarmor.gpg \
          -o /usr/share/keyrings/tailscale-archive-keyring.gpg
      args:
        creates: /usr/share/keyrings/tailscale-archive-keyring.gpg

    - name: Add Tailscale apt repo
      copy:
        dest: /etc/apt/sources.list.d/tailscale.list
        mode: "0644"
        content: |
          deb [signed-by=/usr/share/keyrings/tailscale-archive-keyring.gpg] https://pkgs.tailscale.com/stable/debian {{ ansible_distribution_release }} main

    - name: Install tailscale package
      apt:
        name: tailscale
        state: present
        update_cache: true

    - name: Enable tailscaled
      service:
        name: tailscaled
        enabled: true
        state: started

    - name: Check if Tailscale is already connected
      command: tailscale status
      register: tailscale_status_check
      changed_when: false
      failed_when: false
      ignore_errors: true

    - name: Build Tailscale up command arguments
      when: tailscale_status_check.rc != 0
      set_fact:
        tailscale_args:
          - "up"
          - "--authkey={{ tailscale_authkey }}"

    - name: Add exit node flag if enabled
      when:
        - tailscale_status_check.rc != 0
        - tailscale_advertise_exit_node | default(false)
      set_fact:
        tailscale_args: "{{ tailscale_args + ['--advertise-exit-node'] }}"

    - name: Add routes if configured
      when:
        - tailscale_status_check.rc != 0
        - (tailscale_advertise_routes | default([])) | length > 0
      set_fact:
        tailscale_args: "{{ tailscale_args + ['--advertise-routes=' + (tailscale_advertise_routes | join(','))] }}"

    - name: Bring up tailscale
      when: tailscale_status_check.rc != 0
      command:
        cmd: tailscale
        argv: "{{ tailscale_args }}"
      register: tailscale_up_result
      changed_when: tailscale_up_result.rc == 0
      failed_when: tailscale_up_result.rc != 0

    - name: Display Tailscale connection status
      when: tailscale_status_check.rc == 0
      debug:
        msg: "Tailscale is already connected. Skipping authentication."
