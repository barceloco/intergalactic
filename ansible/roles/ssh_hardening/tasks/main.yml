---
- name: Ensure OpenSSH server installed
  apt:
    name: openssh-server
    state: present
    update_cache: true

- name: Create system SSH authorized_keys directory
  file:
    path: /etc/ssh/authorized_keys.d
    state: directory
    mode: '0755'
    owner: root
    group: root

- name: Configure sshd drop-in
  copy:
    dest: /etc/ssh/sshd_config.d/10-intergalactic.conf
    mode: "0600"
    owner: root
    group: root
    content: |
      Port {{ ssh_port }}

      # SSH keys stored in system location for encrypted home directory support
      AuthorizedKeysFile /etc/ssh/authorized_keys.d/%u

      PermitRootLogin no
      PasswordAuthentication no
      KbdInteractiveAuthentication no
      ChallengeResponseAuthentication no
      UsePAM yes

      PubkeyAuthentication yes
      AuthenticationMethods publickey

      X11Forwarding no
      # Allow local port forwarding (useful for development/debugging)
      # but prevent remote forwarding (security risk)
      AllowTcpForwarding local
      AllowAgentForwarding yes
      PermitTunnel no

      ClientAliveInterval 300
      ClientAliveCountMax 2
      LoginGraceTime 20
      MaxAuthTries 3
      MaxSessions 5

      {% if ssh_allow_users is defined and ssh_allow_users|length > 0 %}
      AllowUsers {% for u in ssh_allow_users %}{{ u }} {% endfor %}
      {% endif %}
  notify: Restart ssh

- name: Ensure SSH service enabled
  service:
    name: ssh
    enabled: true
    state: started
