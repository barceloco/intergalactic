---
# LUKS role: Install cryptsetup for mounting external encrypted devices
# This role does NOT set up encrypted partitions - it only installs cryptsetup
# which is required to mount external LUKS-encrypted USB drives or network storage

- name: Install cryptsetup for LUKS disk encryption
  apt:
    name: cryptsetup
    state: present
    update_cache: true
  when: enable_luks | default(false)

- name: Verify cryptsetup is installed
  command: cryptsetup --version
  register: cryptsetup_version
  changed_when: false
  failed_when: false
  when: enable_luks | default(false)

- name: Display cryptsetup version
  debug:
    msg: "cryptsetup version: {{ cryptsetup_version.stdout | default('not installed') }}"
  when: 
    - enable_luks | default(false)
    - cryptsetup_version.rc == 0

- name: Display LUKS setup summary
  debug:
    msg: |
      ============================================================================
      LUKS Configuration Complete
      ============================================================================
      cryptsetup is installed and ready for use.
      
      This enables mounting external LUKS-encrypted devices (USB drives, network storage).
      Internal partitions are not encrypted.
      
      For manual LUKS operations:
      - List devices: lsblk
      - Check if encrypted: cryptsetup isLuks <device>
      - Open encrypted device: cryptsetup open <device> <name>
      - Mount: mount /dev/mapper/<name> /mnt
      - Close: cryptsetup close <name>
      ============================================================================
  when: enable_luks | default(false)
