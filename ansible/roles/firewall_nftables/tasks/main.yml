---
- name: Install nftables
  apt:
    name: nftables
    state: present
    update_cache: true

- name: Deploy nftables rules
  template:
    src: nftables.conf.j2
    dest: /etc/nftables.conf
    owner: root
    group: root
    mode: "0644"
  notify: Reload nftables

- name: Validate nftables configuration syntax
  command: nft -c -f /etc/nftables.conf
  changed_when: false
  failed_when: false
  register: nftables_syntax_check

- name: Fail if nftables configuration is invalid
  assert:
    that:
      - nftables_syntax_check.rc == 0
    fail_msg: |
      ============================================================================
      ERROR: nftables configuration syntax is invalid!
      ============================================================================
      The nftables rules file has syntax errors. Please check:
      1. The generated /etc/nftables.conf file
      2. The template: ansible/roles/firewall_nftables/templates/nftables.conf.j2
      3. Variable values in your inventory
      
      Syntax check output:
      {{ nftables_syntax_check.stderr | default('No error output') }}
      ============================================================================
    success_msg: "âœ“ nftables configuration syntax is valid"

- name: Enable and start nftables
  service:
    name: nftables
    enabled: true
    state: started
