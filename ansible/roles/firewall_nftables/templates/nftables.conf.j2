#!/usr/sbin/nft -f

flush ruleset

table inet filter {
  chain input {
    type filter hook input priority 0;
    policy drop;

    iif lo accept
    {% if enable_tailscale | default(false) %}
    iifname "tailscale0" tcp dport {{ ssh_port | default(22) }} accept
    {% if internal_dns_enabled | default(false) %}
    iifname "tailscale0" udp dport 53 accept
    iifname "tailscale0" tcp dport 53 accept
    {% endif %}
    {% if edge_ingress_enabled | default(false) %}
    iifname "tailscale0" tcp dport 80 accept
    iifname "tailscale0" tcp dport 443 accept
    {% endif %}
    # Accept all other traffic on Tailscale interface (more secure than opening UDP port globally)
    # Note: This rule will be ignored if tailscale0 doesn't exist yet (e.g., before Tailscale is started)
    iifname "tailscale0" accept
    {% endif %}
    ct state established,related accept

    ip protocol icmp accept
    ip6 nexthdr icmpv6 accept

    {% for p in firewall_allow_tcp_ports %}
    tcp dport {{ p }} accept
    {% endfor %}

    {% if enable_samba | default(false) %}
    # Samba (SMB/CIFS) ports
    tcp dport 445 accept
    tcp dport 139 accept
    udp dport 137 accept
    udp dport 138 accept
    {% endif %}

    {% for p in firewall_allow_udp_ports %}
    udp dport {{ p }} accept
    {% endfor %}

    limit rate {{ firewall_rate_limit | default(10) }}/second counter log prefix "nft-in-drop: " drop
  }

  chain forward {
    type filter hook forward priority 0;
    policy drop;
  }

  chain output {
    type filter hook output priority 0;
    policy accept;
  }
}
