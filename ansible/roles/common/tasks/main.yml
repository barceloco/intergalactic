---
# Pre-flight validation: ensure required variables are set
- name: Validate automation SSH keys are configured
  assert:
    that:
      - automation_authorized_keys is defined
      - automation_authorized_keys | length > 0
    fail_msg: |
      automation_authorized_keys is not set or is empty.
      Please configure SSH keys in all.secrets.yml
      See ansible/inventories/prod/group_vars/all.secrets.yml.example for template.
    success_msg: "Automation SSH keys are configured"

- name: Validate human users SSH keys are configured (if human_users is defined)
  when: human_users is defined and human_users | length > 0
  assert:
    that:
      - item.authorized_keys is defined
      - item.authorized_keys | length > 0
    fail_msg: |
      Human user '{{ item.name }}' has no authorized_keys configured.
      Please add SSH keys for this user in all.secrets.yml
      See ansible/inventories/prod/group_vars/all.secrets.yml.example for template.
    success_msg: "Human user '{{ item.name }}' SSH keys are configured"
  loop: "{{ human_users }}"
  loop_control:
    label: "{{ item.name }}"

- name: Validate Tailscale auth key (if Tailscale is enabled)
  when: enable_tailscale | default(false)
  assert:
    that:
      - tailscale_authkey is defined
      - tailscale_authkey | length > 0
      - tailscale_authkey != "tskey-REPLACE_ME"
      - not tailscale_authkey.startswith("tskey-REPLACE")
    fail_msg: |
      Tailscale is enabled but auth key is not set or is a placeholder.
      Please set tailscale_authkey in all.secrets.yml
      See ansible/inventories/prod/group_vars/all.secrets.yml.example for template.
    success_msg: "Tailscale auth key is configured"

- name: Install minimal base packages (headless safe)
  apt:
    name:
      - openssh-server
      - sudo
      - ca-certificates
      - curl
      - vim
      - rsync
      - chrony
      - python3
      - python3-apt
    state: present
    update_cache: true

- name: Ensure chrony enabled
  service:
    name: chrony
    enabled: true
    state: started

- name: Enforce automation authorized_keys (exclusive)
  authorized_key:
    user: "{{ automation_user }}"
    key: "{{ item }}"
    state: present
    exclusive: true
  loop: "{{ automation_authorized_keys }}"

- name: Enforce human users authorized_keys (exclusive)
  authorized_key:
    user: "{{ item.0.name }}"
    key: "{{ item.1 }}"
    state: present
    exclusive: true
  loop: "{{ (human_users | default([])) | subelements('authorized_keys') }}"

- name: Optionally disable default 'pi' user (if present)
  when: disable_default_pi_user | default(false)
  block:
    - name: Check if 'pi' user exists
      command: id pi
      register: pi_id
      changed_when: false
      failed_when: false

    - name: Lock 'pi' user
      when: pi_id.rc == 0
      user:
        name: pi
        password_lock: true
        shell: /usr/sbin/nologin

- name: Basic sysctl hardening (safe defaults)
  sysctl:
    name: "{{ item.name }}"
    value: "{{ item.value }}"
    state: present
    reload: true
  loop:
    - { name: "net.ipv4.conf.all.rp_filter", value: "1" }
    - { name: "net.ipv4.conf.default.rp_filter", value: "1" }
    - { name: "net.ipv4.tcp_syncookies", value: "1" }
    - { name: "net.ipv4.conf.all.accept_redirects", value: "0" }
    - { name: "net.ipv4.conf.default.accept_redirects", value: "0" }
    - { name: "net.ipv4.conf.all.send_redirects", value: "0" }
    - { name: "net.ipv4.conf.default.send_redirects", value: "0" }

- name: Ensure hostname (if provided)
  when: hostname is defined
  hostname:
    name: "{{ hostname }}"
