---
- name: "Alpheratz (RPi3B+ minimal: SSH, Tailscale, rsync, LUKS)"
  hosts: alpheratz
  become: true
  gather_facts: false
  vars_files:
    - "../inventories/prod/group_vars/all_secrets.yml"
  pre_tasks:
    - name: Ensure .ssh directory exists for known_hosts
      file:
        path: "/root/.ssh"
        state: directory
        mode: '0700'
      delegate_to: localhost
      run_once: true

    - name: Fetch host key using ssh-keyscan (secure host key verification)
      command: >
        ssh-keyscan
        -t ecdsa,ed25519,rsa
        {{ ansible_host | default(inventory_hostname) }}
      register: ssh_keyscan_output
      delegate_to: localhost
      run_once: true
      changed_when: false
      failed_when: false
      # Note: We check the return code below - if ssh-keyscan fails, we fail the playbook
      # This ensures we never connect to a host without verifying its identity

    - name: Fail if ssh-keyscan failed (cannot verify host identity)
      assert:
        that:
          - ssh_keyscan_output.rc == 0
          - ssh_keyscan_output.stdout_lines | length > 0
        fail_msg: |
          ============================================================================
          SECURITY ERROR: Cannot verify host identity!
          ============================================================================
          ssh-keyscan failed to fetch host keys from {{ ansible_host | default(inventory_hostname) }}
          
          This means we cannot securely verify the host's identity before connecting.
          Host key verification is REQUIRED to prevent MITM attacks.
          
          Possible causes:
          1. Host is unreachable (check network connectivity)
          2. SSH service is not running on the host
          3. Firewall is blocking connection
          
          Please fix the connectivity issue and try again.
          ============================================================================
        success_msg: "âœ“ Host key fetched successfully - secure connection verified"

    - name: Add fetched host keys to known_hosts (one key per line, skip comments)
      lineinfile:
        path: "{{ ansible_ssh_known_hosts_file | default('~/.ssh/known_hosts') }}"
        line: "{{ item }}"
        create: true
        mode: '0600'
        regexp: "^{{ item.split()[0] if item.split() | length > 0 else '' }} "
        state: present
      delegate_to: localhost
      run_once: true
      loop: "{{ ssh_keyscan_output.stdout_lines }}"
      when:
        - item is defined
        - item | length > 0
        - not item.startswith('#')
        - item.split() | length >= 3
      # Filter out comment lines, add each valid key line to known_hosts
      # regexp ensures we update existing entries instead of duplicating

    - name: Gather facts after host key verification
      setup:
  roles:
    - common
    - ssh_hardening
    - tailscale
    - luks
