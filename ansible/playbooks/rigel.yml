---
- name: Rigel (RPi4 headless endpoint + docker host)
  hosts: rigel
  become: true
  gather_facts: false
  vars_files:
    - "../inventories/prod/group_vars/all_secrets.yml"
  pre_tasks:
    - name: Ensure .ssh directory exists for known_hosts
      file:
        path: "/root/.ssh"
        state: directory
        mode: '0700'
      delegate_to: localhost
      run_once: true

    - name: Fetch host key using ssh-keyscan (secure host key verification)
      command: >
        ssh-keyscan
        -T 5
        -t ecdsa,ed25519,rsa
        {{ ansible_host | default(inventory_hostname) }}
      register: ssh_keyscan_output
      delegate_to: localhost
      run_once: true
      changed_when: false
      failed_when: false

      # This ensures we never connect to a host without verifying its identity
      # -T 5 sets a 5 second timeout to prevent hanging

    - name: Extract host key from ssh-keyscan output (first valid key)
      set_fact:
        host_key_line: "{{ ssh_keyscan_output.stdout_lines | reject('match', '^#') | first }}"
      delegate_to: localhost
      run_once: true
      when: ssh_keyscan_output.rc == 0 and ssh_keyscan_output.stdout_lines | length > 0

    - name: Add host key to known_hosts using known_hosts module (if ssh-keyscan succeeded)
      known_hosts:
        name: "{{ ansible_host | default(inventory_hostname) }}"
        key: "{{ host_key_line.split()[1] if host_key_line.split() | length > 1 else '' }}"
        path: "{{ ansible_ssh_known_hosts_file | default('~/.ssh/known_hosts') }}"
        state: present
      delegate_to: localhost
      run_once: true
      when:
        - ssh_keyscan_output.rc == 0
        - ssh_keyscan_output.stdout_lines | length > 0
        - host_key_line is defined
        - host_key_line.split() | length >= 3

    - name: Gather facts (will accept host key automatically if ssh-keyscan failed)
      setup:
  roles:
    - common
    - ssh_hardening
    - firewall_nftables
    - fail2ban
    - updates
    - tailscale
    - docker_host
    - docker_deploy
    - monitoring_base
    - monitoring_docker
    - luks
